---
description: Bioinformatics domain-specific conventions for YClade
globs: ["src/yclade/**/*.py", "tests/**/*.py"]
alwaysApply: false
---

# Bioinformatics Conventions

## Y-Chromosome Haplogroup Naming

### YFull Style (Preferred)

Use YFull-style haplogroup notation with SNP suffix:

```python
# CORRECT: YFull style
"R-L21"
"R-M269"
"E-M96"

# AVOID: ISOGG long form (for display only)
"R1b1a1a2a1a2c"
```

### Root Node

The tree root is consistently named:

```python
ROOT_NAME = 'ROOT (Y-Chromosome "Adam")'
```

## Genomic Coordinates

### Reference Genomes

Support three reference assemblies:

```python
ReferenceGenome = Literal["grch37", "grch38", "t2t"]
```

- `grch37` - GRCh37/hg19 coordinates
- `grch38` - GRCh38/hg38 coordinates
- `t2t` - T2T-CHM13v2.0 coordinates

### Position Convention

- Use **1-based** positions (VCF standard)
- Store positions as `int | None` (None if not available for reference)

```python
@dataclass
class SNP:
    position_grch37: int | None = None
    position_grch38: int | None = None
    position_t2t: int | None = None
```

## Chromosome Naming

Normalize Y chromosome names internally to "Y":

```python
Y_CHROMS = {"Y", "chrY", "y", "chry", "24"}

# Normalize to "Y" in Variant objects
return Variant(
    chrom="Y",  # Always normalized
    position=record.pos,
    ...
)
```

## Allele Representation

### Ancestral/Derived

- `ancestral` - The ancestral (original) allele
- `derived` - The derived (mutant) allele

```python
@dataclass
class SNP:
    ancestral: str = ""  # e.g., "C"
    derived: str = ""    # e.g., "T"
```

### Genotype Encoding

- `0` = Reference allele
- `1` = First alternate allele
- `None` = Missing call

```python
# Y chromosome is haploid, take first allele
genotype: int | None = gt[0] if gt else None
```

## Ancient DNA Considerations

### Damage Patterns

Ancient DNA shows characteristic damage patterns:

- C→T transitions (cytosine deamination)
- G→A transitions (reverse complement)

```python
def _is_damage_like(self, snp: SNP, called: str) -> bool:
    """Check if variant looks like ancient DNA damage."""
    # C>T damage (on reference strand)
    if snp.ancestral == "C" and called == "T":
        return True
    # G>A damage (reverse complement of C>T)
    if snp.ancestral == "G" and called == "A":
        return True
    return False
```

### Filtering Strategy

In ancient mode, damage-like transitions are treated as missing data rather than derived calls.

## Quality Scores

### QC Score System

```python
@dataclass
class QCScores:
    qc1_backbone: float   # Backbone consistency (0-1)
    qc2_terminal: float   # Terminal marker consistency (0-1)
    qc3_path: float       # Within-haplogroup path consistency (0-1)
    qc4_posterior: float  # Posterior probability (0-1)
```

### Confidence Thresholds

- High confidence: ≥0.95
- Low confidence: <0.95

## VCF Handling

### Required Fields

- CHROM, POS, REF, ALT (mandatory)
- GT (genotype, required)
- DP (depth, optional but recommended)
- GQ (genotype quality, optional)
- AD (allele depth, optional)

### Filter Defaults

```python
min_depth: int = 10     # Modern DNA default
min_quality: int = 20   # GQ threshold

# Ancient DNA often uses lower depth
if ancient_mode:
    min_depth = 1
```

## SNP Naming

### Multi-Name SNPs

Many SNPs have multiple names:

```python
@dataclass
class SNP:
    name: str              # Primary name: "L21"
    aliases: list[str]     # Other names: ["M529", "S145"]
```

### Alias Resolution

Always resolve aliases to primary names for internal operations:

```python
def get_by_name(self, name: str) -> SNP:
    if name in self._snps:
        return self._snps[name]
    if name in self._alias_map:
        return self._snps[self._alias_map[name]]
    raise KeyError(f"SNP not found: {name}")
```

## Data Sources

### YFull Tree

- Source: https://github.com/YFullTeam/YTree
- Format: JSON with parent→children structure
- Updates: Monthly

### YBrowse SNP Database

- Source: http://ybrowse.org/gbrowse2/gff/
- Formats: CSV, VCF
- Contains: Position mappings, allele info, haplogroup associations
