/*
 * yallHap Pipeline Configuration
 */

// Manifest
manifest {
    name            = 'yallhap-pipeline'
    author          = 'yallHap Contributors'
    homePage        = 'https://github.com/yourusername/yallhap'
    description     = 'Y-chromosome haplogroup inference pipeline'
    mainScript      = 'main.nf'
    nextflowVersion = '>=23.04.0'
    version         = '0.2.0'
}

// Default parameters
params {
    input       = null
    tree        = null
    snp_db      = null
    reference   = 'grch38'
    ancient     = false
    outdir      = './results'
    help        = false

    // Resource defaults
    max_cpus    = 16
    max_memory  = '32.GB'
    max_time    = '24.h'
}

// Process resource labels
process {
    withLabel: 'process_low' {
        cpus   = 1
        memory = '2.GB'
        time   = '1.h'
    }
    withLabel: 'process_medium' {
        cpus   = 2
        memory = '4.GB'
        time   = '4.h'
    }
    withLabel: 'process_high' {
        cpus   = 4
        memory = '8.GB'
        time   = '8.h'
    }
}

// Profiles
profiles {
    standard {
        process.executor = 'local'
    }

    docker {
        docker.enabled = true
        docker.runOptions = '-u $(id -u):$(id -g)'
    }

    singularity {
        singularity.enabled = true
        singularity.autoMounts = true
    }

    conda {
        conda.enabled = true
        process.conda = "${projectDir}/environment.yml"
    }

    slurm {
        process.executor = 'slurm'
        process.queue = 'standard'
    }

    sge {
        process.executor = 'sge'
    }

    test {
        // Test profile with minimal resources
        params.max_cpus = 2
        params.max_memory = '4.GB'
        params.max_time = '1.h'
    }
}

// Capture reports
report {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_report.html"
}

timeline {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_timeline.html"
}

trace {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_trace.txt"
}

dag {
    enabled = true
    file = "${params.outdir}/pipeline_info/pipeline_dag.svg"
}

// Function to ensure resource limits
def check_max(obj, type) {
    if (type == 'memory') {
        try {
            if (obj.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1)
                return params.max_memory as nextflow.util.MemoryUnit
            else
                return obj
        } catch (all) {
            println "ERROR: ${type} configuration is invalid"
            System.exit(1)
        }
    } else if (type == 'time') {
        try {
            if (obj.compareTo(params.max_time as nextflow.util.Duration) == 1)
                return params.max_time as nextflow.util.Duration
            else
                return obj
        } catch (all) {
            println "ERROR: ${type} configuration is invalid"
            System.exit(1)
        }
    } else if (type == 'cpus') {
        try {
            return Math.min(obj, params.max_cpus as int)
        } catch (all) {
            println "ERROR: ${type} configuration is invalid"
            System.exit(1)
        }
    }
}

